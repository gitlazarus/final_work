
# Final work v.2

## Описание

Эта работа реализует ETL-процесс для анализа и загрузки данных из CSV файла в ClickHouse.  
Весь процесс автоматизирован с использованием **Apache Airflow**, **PySpark** и **ClickHouse**.  

DAG выполняет следующие шаги:  

1. Проверка подключения к ClickHouse и PostgreSQL.  
2. Чтение CSV-файла с данными и их обработка.  
3. Сохранение очищенных данных в Parquet для последующего анализа.  
4. Выполнение аналитики:
   - Средний и медианный год постройки зданий  
   - Топ-10 регионов и городов по количеству зданий  
   - Минимальная и максимальная площадь по регионам  
   - Количество зданий по десятилетиям  
5. Загрузка очищенных данных в ClickHouse.  
6. Получение топ-25 домов с площадью > 60 кв.м из ClickHouse.

---

## Структура репозитория

```text
Final_work_v2/
│
├── dags/
│   └── main.py               
├── data/
│   └── russian_houses.csv    
├── docker-compose.yml        
├── Dockerfile                
├── requirements.txt          
├── README.md                 
└── .gitignore                
Ключевые файлы и их назначение
```
Как запустить проект

Клонируйте репозиторий:
```
git clone <https://github.com/gitlazarus/final_work.git>
cd Final_work_v2
```
Поднимите все контейнеры:
```
docker-compose up -d
```
Перейдите в интерфейс Airflow и активируйте DAG main:
```
(http://localhost:8080) 
```

Проверка результатов:
```
1. Airflow логи по проделанным операциям.
```
Реализация:
```
1. Данные не редактируются вручную и не обрезаются.
2. CSV-файл очищается через PySpark (удаляются пустые строки, приводятся типы данных, исправляются форматы чисел).
3. Используется Parquet для промежуточного хранения, что ускоряет аналитику и повторные вычисления.
4. Все шаги объединены в один DAG для простоты запуска и мониторинга.
```
Последовательность задач в DAGe:
```
1. Проверка подключений к ClickHouse.
2. Загрузка файла, преобразование данных и сохранение в Parquet для временного хранения.
3. Выполнение аналитических функций.
4. В случае успеха загрузка в Clickhosue.
```
Требования:
```
1. Docker и Docker Compose
2. Python 3.12+ (для локальной проверки DAG)
3. Airflow 2.9.2 (контейнер)
4. ClickHouse 23+ (контейнер)
5. PostgreSQL 15+ (контейнер, проверка подключения)
```
## Срез данных (первые 50 строк)

```csv
house_id,latitude,longitude,maintenance_year,square,population,region,locality_name,address,full_address,communal_service_id,description
1,44.707617,43.006476,1974,2 661.10,89,Ставропольский край,село Александровское,"с. Александровское, ул. Войтика, д. 31","Ставропольский край, р-н. Александровский, с. Александровское, ул. Войтика, д. 31",1.0,"Жилой дом в , по адресу с. Александровское, ул. Войтика, д. 31, 1974 года постройки, под управлением УК «Жилсервис»."
2,44.706720000000004,43.005281,1989,3 111.10,115,Ставропольский край,село Александровское,"с. Александровское, ул. Войтика, д. 39","Ставропольский край, р-н. Александровский, с. Александровское, ул. Войтика, д. 39",1.0,"Жилой дом в , по адресу с. Александровское, ул. Войтика, д. 39, 1989 года постройки, под управлением УК «Жилсервис»."
3,44.708302,43.006665000000005,1977,2 896.04,89,Ставропольский край,село Александровское,"с. Александровское, ул. Калинина, д. 25","Ставропольский край, р-н. Александровский, с. Александровское, ул. Калинина, д. 25",1.0,"Жилой дом в , по адресу с. Александровское, ул. Калинина, д. 25, 1977 года постройки, под управлением УК «Жилсервис»."
4,44.711946999999995,42.97358,,620.00,30,Ставропольский край,село Александровское,"с. Александровское, ул. Советская, д. 96","Ставропольский край, р-н. Александровский, с. Александровское, ул. Советская, д. 96",1.0,"Жилой дом в , по адресу с. Александровское, ул. Советская, д. 96, под управлением УК «Жилсервис»."
5,44.711946999999995,42.97358,1978,1 061.92,26,Ставропольский край,село Александровское,"с. Александровское, ул. Советская, д. 97","Ставропольский край, р-н. Александровский, с. Александровское, ул. Советская, д. 97",1.0,"Жилой дом в , по адресу с. Александровское, ул. Советская, д. 97, 1978 года постройки, под управлением УК «Жилсервис»."
6,44.707751,43.005515,1978,2 688.70,105,Ставропольский край,село Александровское,"с. Александровское, ул. Войтика, д. 29","Ставропольский край, р-н. Александровский, с. Александровское, ул. Войтика, д. 29",2.0,"Жилой дом в , по адресу с. Александровское, ул. Войтика, д. 29, 1978 года постройки, под управлением ТСЖ «Виктория»."
7,44.711946999999995,42.97358,1973,854.90,40,Ставропольский край,село Александровское,"с. Александровское, ул. Советская, д. 100","Ставропольский край, р-н. Александровский, с. Александровское, ул. Советская, д. 100",3.0,"Жилой дом в , по адресу с. Александровское, ул. Советская, д. 100, 1973 года постройки, под управлением ТСЖ «Изумруд»."
8,44.723622999999996,42.996864,1978,924.40,31,Ставропольский край,село Александровское,"с. Александровское, ул. Заводская, д. 21","Ставропольский край, р-н. Александровский, с. Александровское, ул. Заводская, д. 21",4.0,"Жилой дом в , по адресу с. Александровское, ул. Заводская, д. 21, 1978 года постройки, под управлением ТСЖ «Луч»."
9,44.721765999999995,43.02013,1974,1 011.30,38,Ставропольский край,село Александровское,"с. Александровское, ул. Пионерская, д. 92","Ставропольский край, р-н. Александровский, с. Александровское, ул. Пионерская, д. 92",5.0,"Жилой дом в , по адресу с. Александровское, ул. Пионерская, д. 92, 1974 года постройки, под управлением ТСЖ «Рассвет»."
10,44.710557,43.000278,1963,621.21,20,Ставропольский край,село Александровское,"с. Александровское, ул. К.Маркса, д. 66","Ставропольский край, р-н. Александровский, с. Александровское, ул. К.Маркса, д. 66",6.0,"Жилой дом в , по адресу с. Александровское, ул. К.Маркса, д. 66, 1963 года постройки, под управлением ТСЖ «Содружество»."
11,44.724903999999995,43.003359,1972,681.60,26,Ставропольский край,село Александровское,"с. Александровское, ул. Заводская, д. 13","Ставропольский край, р-н. Александровский, с. Александровское, ул. Заводская, д. 13",7.0,"Жилой дом в , по адресу с. Александровское, ул. Заводская, д. 13, 1972 года постройки, под управлением ТСЖ «Уют»."
12,44.711946999999995,42.97358,1974,854.60,51,Ставропольский край,село Александровское,"с. Александровское, ул. Советская, д. 102","Ставропольский край, р-н. Александровский, с. Александровское, ул. Советская, д. 102",8.0,"Жилой дом в , по адресу с. Александровское, ул. Советская, д. 102, 1974 года постройки, под управлением ТСЖ «Янтарь»."
13,44.234768,43.094941999999996,1969,693.50,28,Ставропольский край,поселок городского типа Анджиевский,"п. Анджиевский, ул. Заводская, д. 28","Ставропольский край, р-н. Минераловодский, п. Анджиевский, ул. Заводская, д. 28",9.0,"Жилой дом в , по адресу п. Анджиевский, ул. Заводская, д. 28, 1969 года постройки, под управлением УК «Аверс»."
14,44.234768,43.094941999999996,1993,454.90,26,Ставропольский край,поселок городского типа Анджиевский,"п. Анджиевский, ул. Московская, д. 1А","Ставропольский край, р-н. Минераловодский, п. Анджиевский, ул. Московская, д. 1А",9.0,"Жилой дом в , по адресу п. Анджиевский, ул. Московская, д. 1А, 1993 года постройки, под управлением УК «Аверс»."
15,44.234768,43.094941999999996,1987,2 245.70,101,Ставропольский край,поселок городского типа Анджиевский,"п. Анджиевский, ул. Набережная, д. 98А","Ставропольский край, р-н. Минераловодский, п. Анджиевский, ул. Набережная, д. 98А",9.0,"Жилой дом в , по адресу п. Анджиевский, ул. Набережная, д. 98А, 1987 года постройки, под управлением УК «Аверс»."
16,44.234768,43.094941999999996,1978,3 998.70,183,Ставропольский край,поселок городского типа Анджиевский,"п. Анджиевский, ул. Трудовая, д. 33","Ставропольский край, р-н. Минераловодский, п. Анджиевский, ул. Трудовая, д. 33",9.0,"Жилой дом в , по адресу п. Анджиевский, ул. Трудовая, д. 33, 1978 года постройки, под управлением УК «Аверс»."
17,44.146484,43.445411,1984,1 522.00,65,Ставропольский край,Георгиевск,"ул. Гастелло, д. 70, к. а","Ставропольский край, г. Георгиевск, ул. Гастелло, д. 70, к. а",10.0,"Жилой дом в Георгиевске, по адресу ул. Гастелло, д. 70, к. а, 1984 года постройки, под управлением УК «Наш Дом»."
18,44.148599,43.473896,1961,558.20,40,Ставропольский край,Георгиевск,"ул. Горийская, д. 8","Ставропольский край, г. Георгиевск, ул. Горийская, д. 8",10.0,"Жилой дом в Георгиевске, по адресу ул. Горийская, д. 8, 1961 года постройки, под управлением УК «Наш Дом»."
19,44.151270000000004,43.484999,1993,1 561.00,71,Ставропольский край,Георгиевск,"пер. Казачий, д. 3","Ставропольский край, г. Георгиевск, пер. Казачий, д. 3",10.0,"Жилой дом в Георгиевске, по адресу пер. Казачий, д. 3, 1993 года постройки, под управлением УК «Наш Дом»."
20,44.131961,43.45107,1976,3 899.80,91,Ставропольский край,Георгиевск,"ул. Калинина, д. 119","Ставропольский край, г. Георгиевск, ул. Калинина, д. 119",10.0,"Жилой дом в Георгиевске, по адресу ул. Калинина, д. 119, 1976 года постройки, под управлением УК «Наш Дом»."
21,44.136140000000005,43.453136,1965,1 970.40,74,Ставропольский край,Георгиевск,"ул. Калинина, д. 130","Ставропольский край, г. Георгиевск, ул. Калинина, д. 130",10.0,"Жилой дом в Георгиевске, по адресу ул. Калинина, д. 130, 1965 года постройки, под управлением УК «Наш Дом»."
22,44.147998,43.468092999999996,1988,3 693.25,158,Ставропольский край,Георгиевск,"ул. Ленина, д. 135","Ставропольский край, г. Георгиевск, ул. Ленина, д. 135",10.0,"Жилой дом в Георгиевске, по адресу ул. Ленина, д. 135, 1988 года постройки, под управлением УК «Наш Дом»."
23,44.125924,43.453235,2011,1 913.60,48,Ставропольский край,Георгиевск,"ул. Мира, д. 3, к. 3","Ставропольский край, г. Георгиевск, ул. Мира, д. 3, к. 3",10.0,"Жилой дом в Георгиевске, по адресу ул. Мира, д. 3, к. 3, 2011 года постройки, под управлением УК «Наш Дом»."
24,44.124818,43.4448,2013,2 085.20,45,Ставропольский край,Георгиевск,"ул. Тронина, д. 7/1, к. 1","Ставропольский край, г. Георгиевск, ул. Тронина, д. 7/1, к. 1",10.0,"Жилой дом в Георгиевске, по адресу ул. Тронина, д. 7/1, к. 1, 2013 года постройки, под управлением УК «Наш Дом»."
```

Полный CSV доступен по ссылке:
[Скачать CSV](https://disk.yandex.ru/d/HfALdldItWKhig)

Обратная связь: 
```
tg: @tmplnameforfeedback
```

